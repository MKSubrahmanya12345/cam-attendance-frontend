<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face Enrollment ‚Äî Magic Circle</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

  <!-- Google APIs -->
  <script async defer src="https://apis.google.com/js/api.js"></script>
  <script async defer src="https://accounts.google.com/gsi/client"></script>

  <link rel="stylesheet" href="styles.css" />
</head>

<body class="faceid-bg min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-xl rounded-lg p-6 text-center shadow-xl relative ui-shell">
    <button id="cancel-btn" class="cancel-btn absolute left-4 top-4">Cancel</button>

    <h1 class="title text-2xl font-semibold mb-2">Face Enrollment</h1>
    <p id="instruction-text" class="instruction text-gray-300 mb-4">
      Align your face and press ‚ÄúCapture Photo‚Äù.
    </p>

    <div class="stage" id="stage">
      <div class="video-wrap relative flex justify-center">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="circle_canvas"></canvas>
        <div class="vignette"></div>
      </div>
    </div>

    <canvas id="snap_canvas" class="hidden"></canvas>

    <!-- üì∏ Manual Capture Button -->
    <button id="capture-btn"
      class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300">
      üì∏ Capture Photo
    </button>

    <p class="caption mt-4 text-sm text-gray-400">Captured Images</p>
    <div id="photo-preview-bar" class="preview-bar flex justify-center gap-2 mt-2 h-16 overflow-x-auto"></div>

    <!-- ‚úÖ Submit Button -->
    <div class="done-wrap mt-6">
      <button id="submit-btn"
        class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-300">
        ‚úÖ Submit to Google Drive
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBujiz5R1qEHcLvlMp9fQIViIMuWs3gRZk",
      authDomain: "cam-attendance-a4881.firebaseapp.com",
      projectId: "cam-attendance-a4881",
      storageBucket: "cam-attendance-a4881.appspot.com",
      messagingSenderId: "344849505667",
      appId: "1:344849505667:web:9a8ddb0a009f458fca2ab6",
      measurementId: "G-RLBS140J6Y",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- Elements ---
    const videoEl = document.getElementById("video");
    const circleCanvas = document.getElementById("circle_canvas");
    const snapCanvas = document.getElementById("snap_canvas");
    const captureBtn = document.getElementById("capture-btn");
    const submitBtn = document.getElementById("submit-btn");
    const instr = document.getElementById("instruction-text");
    const previewBar = document.getElementById("photo-preview-bar");
    const cancelBtn = document.getElementById("cancel-btn");

    const ctx = circleCanvas.getContext("2d", { alpha: true });
    const snapCtx = snapCanvas.getContext("2d");
    const captured = {};

    // --- Canvas Setup ---
    let cssW = 0, cssH = 0, dpr = window.devicePixelRatio || 1;
    function resizeCanvas() {
      const rect = circleCanvas.getBoundingClientRect();
      if (!rect) return;
      cssW = rect.width; cssH = rect.height;
      dpr = window.devicePixelRatio || 1;
      circleCanvas.width = Math.round(cssW * dpr);
      circleCanvas.height = Math.round(cssH * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    requestAnimationFrame(resizeCanvas);

    // --- Capture Photo ---
    captureBtn.addEventListener("click", () => {
      if (!videoEl.videoWidth || !videoEl.videoHeight) {
        instr.textContent = "Camera not active or not detected.";
        return;
      }

      const poseName = `photo_${Object.keys(captured).length + 1}`;
      const vW = videoEl.videoWidth, vH = videoEl.videoHeight;
      snapCanvas.width = vW; snapCanvas.height = vH;
      snapCtx.save(); snapCtx.translate(vW, 0); snapCtx.scale(-1, 1);
      snapCtx.drawImage(videoEl, 0, 0, vW, vH); snapCtx.restore();

      const dataUrl = snapCanvas.toDataURL("image/jpeg", 0.9);
      captured[poseName] = dataUrl;

      const img = document.createElement("img");
      img.src = dataUrl;
      img.className = "preview-thumb w-16 h-16 object-cover rounded";
      previewBar.appendChild(img);

      instr.textContent = `Captured (${Object.keys(captured).length})`;
      submitBtn.classList.remove("hidden");
    });

    // --- Camera Start/Stop ---
    let camera = null;
    async function startCamera() {
      try {
        camera = new Camera(videoEl, { onFrame: async () => {}, width: 480, height: 480 });
        await camera.start();
      } catch (e) {
        instr.textContent = "Camera error: " + e.message;
      }
    }
    function stopCamera() {
      try {
        if (camera && camera.stop) camera.stop();
        if (videoEl.srcObject) {
          const s = videoEl.srcObject;
          if (s.getTracks) s.getTracks().forEach(t => t.stop());
          videoEl.srcObject = null;
        }
      } catch (e) {}
    }
    cancelBtn.addEventListener("click", () => {
      stopCamera();
      instr.textContent = "Enrollment cancelled";
    });

    // --- Google Drive Upload ---
    submitBtn.addEventListener("click", async () => {
      if (Object.keys(captured).length === 0) {
        instr.textContent = "Please capture at least one photo.";
        return;
      }

      instr.textContent = "Authorizing Google Drive...";

      const CLIENT_ID = "391305144947-10kjh8tk1ng6vks4ipkd3fi15jmh8dv9.apps.googleusercontent.com";
      const SCOPES = "https://www.googleapis.com/auth/drive.file";

      await new Promise((r) => gapi.load("client", r));
      await gapi.client.init({
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      });

      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (res) => {},
      });

      const tokenResponse = await new Promise((resolve) => {
        tokenClient.callback = (res) => resolve(res);
        tokenClient.requestAccessToken({ prompt: "consent" });
      });

      const accessToken = tokenResponse.access_token;
      const about = await gapi.client.drive.about.get({ fields: "user(emailAddress)" });
      const email = about.result.user.emailAddress;

      const branch = email.split("_")[0]?.toUpperCase() || "UNKNOWN";
      const section = email.split("_")[1]?.split("@")[0]?.toUpperCase() || "GEN";
      const yearFolderName = "2nd Year";

      async function getOrCreateFolder(name, parentId = null) {
        const q = `'${parentId || "root"}' in parents and name='${name}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
        const res = await gapi.client.drive.files.list({ q, fields: "files(id,name)" });
        if (res.result.files?.length > 0) return res.result.files[0].id;
        const folderMeta = { name, mimeType: "application/vnd.google-apps.folder" };
        if (parentId) folderMeta.parents = [parentId];
        const create = await gapi.client.drive.files.create({ resource: folderMeta, fields: "id" });
        return create.result.id;
      }

      const yearId = await getOrCreateFolder(yearFolderName);
      const branchId = await getOrCreateFolder(branch, yearId);
      const studentId = await getOrCreateFolder(`${branch}_${section}`, branchId);

      instr.textContent = "Uploading to Google Drive...";
      for (const [pose, base64] of Object.entries(captured)) {
        const blob = await (await fetch(base64)).blob();
        const metadata = { name: `${pose}.jpg`, mimeType: "image/jpeg", parents: [studentId] };
        const form = new FormData();
        form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        form.append("file", blob);
        const upload = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
          method: "POST",
          headers: { Authorization: "Bearer " + accessToken },
          body: form,
        });
        if (upload.ok) {
          console.log(`‚úÖ Uploaded ${pose} ‚Üí https://drive.google.com/drive/folders/${studentId}`);
        }
      }

      instr.innerHTML = `‚úÖ Uploaded successfully! 
        <a href="https://drive.google.com/drive/folders/${studentId}" target="_blank" class="underline text-blue-400">View in Drive</a>`;
    });

    startCamera();
  </script>
</body>
</html>
